graph TD
    %% ---------- å…¨å±€æ ·å¼ä¸è§’è‰²æ—å®šä¹‰ ----------
    classDef planner fill:#e1f5fe,stroke:#01579b,stroke-width:3px,stroke-dasharray: 5 5;
    classDef executor fill:#f3e5f5,stroke:#4a148c,stroke-width:2px;
    classDef critic fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef api fill:#e8f5e9,stroke:#1b5e20,stroke-width:1px;
    classDef asset fill:#fff3e0,stroke:#e65100,stroke-width:1px,stroke-dasharray: 3 3;
    classDef memory fill:#ffebcc,stroke:#bf360c,stroke-width:2px,stroke-dasharray: 8 8;

    %% ========== é˜¶æ®µ0ï¼šå¯åŠ¨ä¸åˆ†å±‚è®°å¿†ç³»ç»Ÿï¼ˆå‚è€ƒUniVAè®°å¿†æ¶æ„ï¼‰==========
    Start(("ğŸ¬ ç”¨æˆ·éœ€æ±‚è¾“å…¥"))
    Start -->|"Input: {raw_text: string, ref_images?: url[], brand_guidelines?: pdf}"| IntentParser

    subgraph Memory_System [åˆ†å±‚è®°å¿†ç³»ç»ŸÂ·Long-term Memory]
        direction LR
        GlobalKB[(ğŸŒ å…¨å±€çŸ¥è¯†åº“<br/>å½±è§†è¯­æ³•/å¹¿å‘Šæ³•è§„)]:::memory
        TaskContext[(ğŸ“‹ ä»»åŠ¡ä¸Šä¸‹æ–‡<br/>å½“å‰åˆ†é•œ/è§’è‰²é“¶è¡Œ)]:::memory
        UserPref[(ğŸ‘¤ ç”¨æˆ·åå¥½è®°å¿†<br/>é£æ ¼/å†å²åé¦ˆ)]:::memory
    end

    IntentParser[ğŸ¤– Planner Agent<br/>æ„å›¾åˆ†è§£å™¨]:::planner
    IntentParser -->|"Output: structured_brief: {narrative_goal, key_visuals, target_duration}"| DirectorPlanner
    IntentParser <-->|è¯»å†™: ç”¨æˆ·å†å²é£æ ¼| UserPref

    %% ========== é˜¶æ®µ1ï¼šç»“æ„åŒ–é¢„ç”Ÿäº§ï¼ˆGoogle ADK / MovieAgentèŒƒå¼ï¼‰==========
    DirectorPlanner[ğŸ¤– Director Agent<br/>æ€»å¯¼æ¼”æ™ºèƒ½ä½“]:::planner
    DirectorPlanner -->|"è¯»: å…¨å±€çŸ¥è¯†åº“+ä»»åŠ¡ä¸Šä¸‹æ–‡"| GlobalKB
    DirectorPlanner -->|"è¯»: å“ç‰Œè§’è‰²é“¶è¡Œ"| TaskContext
    
    DirectorPlanner -->|"Output1: Script_JSON {scenes:[], shot_table:[], character_bank, camera_moves}"| ScriptAsset[ğŸ“„ ç»“æ„åŒ–å‰§æœ¬]:::asset
    DirectorPlanner -->|"Output2: Initial_Prompt_Templates {scene_id: prompt_template}"| PromptTemplateAsset[ğŸ“ åˆå§‹æç¤ºè¯æ¨¡æ¿]:::asset
    DirectorPlanner -->|"Output3: Material_Requirements {missing_anchors:[äººç‰©, åœºæ™¯]}"| MaterialReqAsset[ğŸ“¦ ç´ æéœ€æ±‚æ¸…å•]:::asset

    %% æ˜¾å¼æˆæœ¬é¢„ä¼°èŠ‚ç‚¹ï¼ˆæ–°å¢ï¼Œå·¥ç¨‹è½åœ°å…³é”®ï¼‰
    ScriptAsset --> CostEstimator[ğŸ’° æˆæœ¬é¢„ä¼°ä¸æ—©åœä»²è£å™¨]:::critic
    CostEstimator -->|"Input: duration, iteration_policy, model_tier"| UserConfirm{ç”¨æˆ·ç¡®è®¤é¢„ç®—?}
    UserConfirm -->|Yes| MaterialGen

    %% ========== é˜¶æ®µ2ï¼šå¤šæ™ºèƒ½ä½“æ‰§è¡Œå±‚ï¼ˆMCPå·¥å…·æœåŠ¡å™¨æ¶æ„Â·UniVA/Moraï¼‰==========
    subgraph Phase2_Execution [å¤šæ™ºèƒ½ä½“æ‰§è¡Œé›†ç¾¤ Â· MCP Tool Servers]
        direction TB
        
        %% æ™ºèƒ½ä½“1ï¼šç´ æç”Ÿæˆå™¨ï¼ˆNano Banana Proï¼‰
        MaterialGen[ğŸ¨ Executor: ç´ æç”Ÿæˆå™¨<br/>Nano Banana Pro]:::executor
        MaterialReqAsset --> MaterialGen
        MaterialGen -->|"Output: Asset_Pack_V1 {images:[{id, url, latent}], videos:[{id, url}]}"| AssetPackV1[ğŸ“ åˆå§‹ç´ æåŒ…]:::asset
        
        %% æ™ºèƒ½ä½“2ï¼šæç¤ºè¯å·¥ç¨‹å¸ˆï¼ˆClaude 3.7 - ç»“æ„åŒ–æ”¹å†™ï¼‰
        PromptEngineer[âœï¸ Executor: æç¤ºè¯å·¥ç¨‹å¸ˆ<br/>Claude 3.7]:::executor
        PromptTemplateAsset --> PromptEngineer
        AssetPackV1 --> PromptEngineer
        PromptEngineer -->|"Output: Optimized_Prompts {scene_id: prompt_with_@ref, negative_prompt, seed_space}"| OptimizedPromptAsset[ğŸ”– ä¼˜åŒ–æç¤ºè¯é›†]:::asset
        
        %% æ™ºèƒ½ä½“3ï¼šä½æ¸…é¢„æ¼”ç”Ÿæˆå™¨ï¼ˆSeedance 1.0 liteï¼‰
        SeedanceBatch[ğŸ¬ Executor: é¢„æ¼”ç”Ÿæˆå™¨<br/>Seedance 1.0 lite]:::executor
        OptimizedPromptAsset --> SeedanceBatch
        AssetPackV1 --> SeedanceBatch
        SeedanceBatch -->|"Output: Draft_Videos {variants:[{variant_id, url, seed, latency}]}"| DraftVideosAsset[ğŸï¸ ä½æ¸…è‰ç¨¿ç»„<br/>4-6å˜ä½“]:::asset
    end

    %% ========== é˜¶æ®µ3ï¼šè¿ç»­æ€§ç›‘ç£ä¸é”å®šéª¨æ¶ï¼ˆGoogle ADKæ ¸å¿ƒè´¡çŒ®ï¼‰==========
    subgraph Phase3_Critic [è¿ç»­æ€§ç›‘ç£ä¸éª¨æ¶é”å®š]
        ContinuitySupervisor[ğŸ” Critic: è¿ç»­æ€§ç›‘ç£å‘˜<br/>Gemini 3 Pro + Video-Bench]:::critic
        DraftVideosAsset --> ContinuitySupervisor
        AssetPackV1 --> ContinuitySupervisor
        
        ContinuitySupervisor -->|"Output: Eval_Report {variant_scores, temporal_consistency_score, semantic_alignment, flaws:[{timestamp, type}]}"| ScoreReport[ğŸ“Š å¤šç»´åº¦è´¨æ£€æŠ¥å‘Š]:::asset
        
        MotionLock[âš–ï¸ å†³ç­–: éª¨æ¶é”å®š]:::critic
        ScoreReport --> MotionLock
        MotionLock -->|"Yes + best_variant_id"| LockedSkeleton[ğŸ”’ é”å®šéª¨æ¶è§†é¢‘<br/>+ å¯¹åº”ç§å­]:::asset
        MotionLock -->|"No + feedback_data"| PlannerFeedback[â†©ï¸ åé¦ˆå›è·¯â†’Director]:::planner
    end

    %% åé¦ˆå›è·¯
    PlannerFeedback --> DirectorPlanner

    %% ========== é˜¶æ®µ4ï¼šé”šç‚¹å¸§é«˜æ¸…é‡ç»˜ä¸ä¸€è‡´æ€§é”å±‚ ==========
    subgraph Phase4_Refinement [å‡ç†µé‡ç»˜ä¸ä¸€è‡´æ€§æ³¨å…¥]
        ExtractKeyframes[ğŸ–¼ï¸ å·¥å…·: æ™ºèƒ½å…³é”®å¸§æŠ½å–<br/>åŸºäºåœºæ™¯åˆ‡åˆ†+è¿åŠ¨å³°å€¼]:::api
        LockedSkeleton --> ExtractKeyframes
        ExtractKeyframes -->|"Output: Keyframes {frame_id, timestamp, low_res_url}"| LowResFrames[ğŸ–¼ï¸ ä½æ¸…é”šç‚¹å¸§ç»„]:::asset
        
        NanoRedraw[ğŸ¨ Executor: é«˜æ¸…é‡ç»˜å™¨<br/>Nano Banana Pro + Set-of-Marks]:::executor
        LowResFrames --> NanoRedraw
        NanoRedraw -->|"Output: HighRes_Anchors {frame_id, 4k_url, style_latent}"| HighResFrames[ğŸ–¼ï¸ é«˜æ¸…é”šç‚¹å¸§ç»„<br/>4K]:::asset
        
        %% ä¸€è‡´æ€§æ ¡éªŒå­æ™ºèƒ½ä½“ï¼ˆæ–°å¢ï¼šé˜²é£æ ¼æ¼‚ç§»ï¼‰
        ConsistencyChecker[ğŸ§ª Critic: ç‰¹å¾ä¸€è‡´æ€§æ ¡éªŒå™¨]:::critic
        HighResFrames --> ConsistencyChecker
        LockedSkeleton --> ConsistencyChecker
        ConsistencyChecker -->|"Output: Similarity_Report {cosine_sim>=0.92? pass/fail, drift_map}"| ConsistencyPass{ç‰¹å¾ç›¸ä¼¼åº¦è¾¾æ ‡?}
        ConsistencyPass -->|No| NanoRedraw
    end

    %% ========== é˜¶æ®µ5ï¼šå½±è§†çº§æˆç‰‡æ¸²æŸ“ï¼ˆVeo 3.1 + å¤šæ¨¡æ€æ¡ä»¶ï¼‰==========
    subgraph Phase5_FinalRender [çº¦æŸæ¸²æŸ“ä¸å½±è§†çº§è¾“å‡º]
        Combiner[ğŸ§© Executor: å¤šæ¨¡æ€æ¡ä»¶ç»„è£…å™¨<br/>Gemini 3 Pro]:::executor
        LockedSkeleton --> Combiner
        HighResFrames --> Combiner
        OptimizedPromptAsset --> Combiner
        
        Combiner -->|"Output: Veo_Payload {ingredients:[anchor_img_IDs], motion_guidance:video_ID, prompt, audio_style}"| VeoPayload[ğŸ“¦ Veo 3.1 è¾“å…¥åŒ…]:::asset
        
        VeoRender[ğŸ¬ æ ¸å¿ƒæ¸²æŸ“å¼•æ“<br/>Veo 3.1 / Veo 3.2]:::api
        VeoPayload --> VeoRender
        VeoRender -->|"Output: Final_Candidate {video_url, srt_captions, audio_track}"| CandidateVideo[ğŸ¥ å€™é€‰æˆç‰‡]:::asset
        
        %% éŸ³é¢‘/é…ä¹æ™ºèƒ½ä½“ï¼ˆå¯é€‰ï¼‰
        ComposerAgent[ğŸµ Executor: é…ä¹å¸ˆ<br/>Lyria / Piapi]:::executor
        ScriptAsset --> ComposerAgent
        ComposerAgent -->|"Output: Generated_Audio {bgm_url, voiceover_url}"| AudioAsset[ğŸ§ éŸ³é¢‘ç´ æ]:::asset
        AudioAsset --> VeoRender
    end

    %% ========== é˜¶æ®µ6ï¼šç»ˆç‰ˆè´¨æ£€ä¸é—­ç¯è¿­ä»£ï¼ˆäººæœºååŒï¼‰==========
    subgraph Phase6_QA [ç»ˆç‰ˆè´¨æ£€ä¸å‘å¸ƒå†³ç­–]
        FinalInspector[ğŸ”¬ Critic: ç»ˆç‰ˆè´¨æ£€å‘˜<br/>Gemini 3 Pro + VQ-Insight]:::critic
        CandidateVideo --> FinalInspector
        ScriptAsset --> FinalInspector
        
        FinalInspector -->|"Output: QA_Report {overall_score, temporal_consistency, character_fidelity, artifacts:[{frame, type}]}"| FinalReport[ğŸ“‹ ç»ˆç‰ˆè´¨æ£€æŠ¥å‘Š]:::asset
        
        QualityGate[âš–ï¸ è´¨é‡é—¨ç¦å†³ç­–]:::critic
        FinalReport --> QualityGate
        
        QualityGate -->|"Yes (score>=8.5)"| Deliver[âœ… äº¤ä»˜ä¸å¤šå¹³å°å‘å¸ƒ]:::executor
        QualityGate -->|"No - å±€éƒ¨ç‘•ç–µ"| LocalFix[ğŸ” å±€éƒ¨é‡ç»˜å›è·¯<br/>â†’ æŒ‡å®šå¸§é‡ç»˜]:::critic
        QualityGate -->|"No - å…¨å±€ç»“æ„"| GlobalFix[ğŸ”„ å…¨å±€å‰§æœ¬å›è·¯<br/>â†’ å¯¼æ¼”æ™ºèƒ½ä½“]:::planner
    end

    LocalFix --> NanoRedraw
    GlobalFix --> DirectorPlanner
    
    Deliver -->|"Output: {final_video_url, frame_accurate_captions, compliance_report}"| Client[ğŸ“± å®¢æˆ·/å¹³å°]

    %% å…³è”è®°å¿†ç³»ç»Ÿè´¯ç©¿å…¨å±€
    DirectorPlanner <--> TaskContext
    ContinuitySupervisor <--> TaskContext
    FinalInspector <--> TaskContext